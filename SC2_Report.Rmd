---
title: "Using ABC to Infer Parameters of a Simulated Zombie Epidemic"
author: "Henry Bourne, Emma Tarmey, Rachel Wood"
output: 
  pdf_document:
    df_print: paged
    keep_tex: yes
date: "June 2023"
header-includes:
- \usepackage{tikz}
- \usepackage{fvextra}
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      dev = 'pdf',
                      pdf.options(encoding = "ISOLatin9.enc"),
                      message = FALSE,
                      warning = FALSE,
                      tidy.opts = list(width.cutoff=50), tidy=TRUE,
                      fig.pos ="H", out.width = '60%',
                      fig.align = 'center'
                      )
library(ggplot2)

library(devtools)
library(ZombieSim)
theme_set(theme_linedraw())
options(scipen = 999)
```

# The REVISIT package 

\textbf{Need to create a package with appropriate folders and documentation - am happy to start on this}

## Documentation

## Integration of R and C++

## Simulations

## Parallelisation

# Generating SZR data
We simulate the zombie epidemic using the `generate.SIR.data()` function, which is given by the code below. For ease, this function has also been included in our `intractmodelinf` package.

We use this to simulate an outbreak for 3 different populations of different sizes:

- Students (\textbf{REVISIT} and staff?) at the University of Bristol
- Residents in the city of Bristol
- Residents in the UK

The data on these simulated outbreaks is included in our package

```{r}
N     <-5000
initial <- generateStartCond(N, initial.inf = 10)

new.example <- generateSZRdata(initial ,total.T     = 50)
```

# Implementing ABC

# Checking Results

```{r, eval}
#bristol.uni.example <- read.csv("data/bristol_uni_example.csv", header = TRUE)
#bristol.example     <- read.csv("data/bristol_example.csv", header = TRUE)
#UK.example          <- read.csv("data/UK_example.csv", header = TRUE)

legend.colors <- c("Susceptible" = "#56B4E9", "Zombies" = "#E69F00", "Removed" = "#0072B2")
source(file = "intractmodelinf/R/plots.R")

plot.SZR(new.example$results) + theme_linedraw() +theme_bw()
```




```{r}
simulated.mat <- new.example$results
simulated.mat  <- as.matrix(simulated.mat[,2:4])
head(simulated.mat )
priorMin <- c(0.000004,0.000004,  0.000004) 
priorMax <- c(0.0015 ,0.001, 0.001)
res <- abcRej(simulated.mat , 10000, 400, priorMin, priorMax)
head(res)
```

```{r}
library(latex2exp)
require(ggplot2)
require(gridExtra)
plot.posterior.samples <- function(sample, mean){
  beta_plot <- ggplot(data = sample, aes(x = beta)) + 
    geom_density(colour = "steelblue2", fill = "steelblue2", alpha = 0.5) +
    geom_vline(aes(xintercept = mean[1]))+
    labs(x = TeX("$\\hat{\\beta}$"), y = "Accepted Samples") +
    theme_classic()
  kappa_plot <- ggplot(data = sample, aes(x = kappa)) + 
    geom_density(fill = "steelblue2", alpha = 0.5,colour = "steelblue2") +
    geom_vline(aes(xintercept = mean[2])) +
    labs(x = TeX("$\\hat{\\kappa}$"), y = "Accepted Samples") +
    theme_classic()
  rho_plot <- ggplot(data = sample, aes(x = rho)) + 
    geom_density(colour = "steelblue2", fill = "steelblue2", alpha = 0.5) +
    geom_vline(aes(xintercept = mean[3]))+
    labs(x = TeX("$\\hat{\\rho}$"), y = "Accepted Samples") +
    theme_classic()
  return(list(beta_plot, kappa_plot, rho_plot))
}
```


```{r, message=FALSE}
library(ggplot2)
library(dplyr)
library(ggthemes)
means <- c(new.example$beta, new.example$kappa, new.example$rho)
samples <- res %>%
  as_tibble()
colnames(samples) <- c("beta", "kappa", "rho")  

plots <- plot.posterior.samples(samples, means)
plots[[1]]
plots[[2]]
plots[[3]]
```

